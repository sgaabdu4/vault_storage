name: Flutter CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call:

jobs:
  version-check:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          # Extract version from pubspec.yaml
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | tr -d '\r')
          echo "Version in pubspec.yaml: $PUBSPEC_VERSION"
          
          # Extract version from CHANGELOG.md (first occurrence of ## [version])
          CHANGELOG_VERSION=$(grep -m 1 '## \[' CHANGELOG.md | sed 's/.*\[\(.*\)\].*/\1/' | tr -d '\r')
          echo "Version in CHANGELOG.md: $CHANGELOG_VERSION"
          
          # Compare versions
          if [ "$PUBSPEC_VERSION" != "$CHANGELOG_VERSION" ]; then
            echo "‚ùå Version mismatch!"
            echo "   pubspec.yaml: $PUBSPEC_VERSION"
            echo "   CHANGELOG.md: $CHANGELOG_VERSION"
            echo ""
            echo "Please ensure the version in CHANGELOG.md matches pubspec.yaml"
            exit 1
          else
            echo "‚úÖ Version consistency check passed: $PUBSPEC_VERSION"
          fi

  format:
    name: Check Formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      - name: Check formatting
        run: dart format --line-length=100 --set-exit-if-changed .

  analyze:
    name: Analyze Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      - name: Analyze code
        run: flutter analyze --fatal-infos

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test --coverage

  pana:
    name: Package Analysis (PANA)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Cache Flutter dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install dependencies
        run: flutter pub get

      - name: Activate PANA
        run: dart pub global activate pana

      - name: Run PANA analysis and check score
        run: |
          RESULT=$(dart pub global run pana . --json)
          SCORE=$(echo "$RESULT" | jq '.scores.grantedPoints')
          TOTAL=$(echo "$RESULT" | jq '.scores.maxPoints')
          echo "PANA Score: $SCORE/$TOTAL"
          if [ "$SCORE" -lt "$TOTAL" ]; then
            echo "$RESULT" | jq '.suggestions'
            echo "‚ùå PANA analysis failed. Score: $SCORE/$TOTAL"
            echo "Package must achieve maximum PANA score including WASM compatibility"
            exit 1
          else
            echo "‚úÖ PANA analysis passed. Perfect score: $SCORE/$TOTAL"
          fi

  tag:
    name: Auto-Tag Release
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [version-check, format, analyze, test, pana]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag_created: ${{ steps.tag.outputs.tag_created }}
      version: ${{ steps.tag.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create tag if version changed
        id: tag
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | tr -d '\r')
          TAG="v$VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ÑπÔ∏è Tag $TAG already exists ‚Äî skipping"
            echo "tag_created=false" >> "$GITHUB_OUTPUT"
          else
            echo "üè∑Ô∏è Creating tag $TAG"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "$TAG"
            git push origin "$TAG"
            echo "‚úÖ Tag $TAG created and pushed"
            echo "tag_created=true" >> "$GITHUB_OUTPUT"
          fi

  publish:
    name: Publish to pub.dev
    if: needs.tag.outputs.tag_created == 'true'
    needs: tag
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Verify version
        run: |
          EXPECTED="${{ needs.tag.outputs.version }}"
          ACTUAL=$(grep '^version:' pubspec.yaml | sed 's/version: *//' | tr -d '\r')
          if [ "$EXPECTED" != "$ACTUAL" ]; then
            echo "‚ùå Version mismatch: expected $EXPECTED, got $ACTUAL"
            exit 1
          fi
          echo "‚úÖ Version verified: $ACTUAL"

      - name: Dry run publish
        run: dart pub publish --dry-run

      - name: Publish to pub.dev
        run: dart pub publish --force
